#!/usr/bin/env bash
set -euo pipefail

die() {
  echo "[cx-commit] $1" >&2
  exit 1
}

command -v git >/dev/null 2>&1 || die "git is required."
command -v codex >/dev/null 2>&1 || die "codex CLI is required."

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || die "Run inside a git repository."

diff_output="$(git diff --cached)"

if [[ -z ${diff_output// } ]]; then
  die "No staged changes to describe."
fi

prompt=$(cat <<EOF
Generate a single-line Conventional Commit subject for the staged diff below.
Requirements:
- Format: <type>: <short description>
- Allowed types: feat, fix, refactor, chore, docs, test, perf
- No body text; only the subject line

Diff:
$diff_output
EOF
)

message="$(codex --profile analyze <<<"$prompt")"
message="$(printf '%s\n' "$message" | head -n 1 | tr -d '\r')"
message="${message#"${message%%[![:space:]]*}"}"
message="${message%"${message##*[![:space:]]}"}"

if [[ -z ${message// } ]]; then
  die "Codex did not return a commit message."
fi

echo "Proposed commit message: $message"
read -r -p "Use this commit message? [y/N] " reply

case "$reply" in
  y|Y)
    git commit -m "$message"
    ;;
  *)
    echo "[cx-commit] Aborted."
    ;;
esac
